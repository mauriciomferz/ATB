name: CI

on:
  pull_request:
    branches:
      - main
      - 'release/*'
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  # ============================================================================
  # OPA Policy Tests
  # ============================================================================
  opa-tests:
    name: OPA Policy Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: latest

      - name: OPA check (syntax validation)
        run: opa check opa/policy/

      - name: OPA format check
        run: opa fmt --diff opa/policy/*.rego

      - name: OPA test (policy unit tests)
        run: opa test opa/policy/ -v --v0-compatible

      - name: OPA coverage report
        run: |
          opa test opa/policy/ --coverage --format=json --v0-compatible > coverage.json
          echo "### OPA Policy Coverage" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat coverage.json | jq '.coverage' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Go Tests
  # ============================================================================
  go-tests:
    name: Go Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: atb-gateway-go/go.mod
          cache: true
          cache-dependency-path: atb-gateway-go/go.sum

      - name: Go mod verify
        working-directory: atb-gateway-go
        run: go mod verify

      - name: Go vet
        working-directory: atb-gateway-go
        run: go vet ./...

      - name: Go unit tests
        working-directory: atb-gateway-go
        run: go test ./... -v -race -coverprofile=coverage.out

      - name: Go coverage summary
        working-directory: atb-gateway-go
        run: |
          echo "### Go Test Coverage" >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.out | tail -1 >> $GITHUB_STEP_SUMMARY

      - name: Build binaries
        working-directory: atb-gateway-go
        run: |
          go build -o bin/broker ./cmd/broker
          go build -o bin/agentauth ./cmd/agentauth

  # ============================================================================
  # Security Scanning
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: atb-gateway-go/go.mod
          cache: true
          cache-dependency-path: atb-gateway-go/go.sum

      - name: Go govulncheck
        working-directory: atb-gateway-go
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: atb-gateway-py/requirements.txt

      - name: Python pip-audit
        working-directory: atb-gateway-py
        run: |
          python -m pip install --upgrade pip
          python -m pip install pip-audit
          python -m pip_audit -r requirements.txt

  # ============================================================================
  # Helm Chart Validation
  # ============================================================================
  helm-lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Helm lint
        run: helm lint charts/atb

      - name: Helm template (staging)
        run: helm template atb charts/atb -f charts/atb/values-staging.yaml --debug > /dev/null

      - name: Helm template (prod)
        run: helm template atb charts/atb -f charts/atb/values-prod.yaml --debug > /dev/null

  # ============================================================================
  # Documentation
  # ============================================================================
  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check.json'
        continue-on-error: true

      - name: Validate JSON schemas
        run: |
          for schema in schemas/*.schema.json; do
            echo "Validating $schema..."
            python3 -c "import json; json.load(open('$schema'))" || exit 1
          done
