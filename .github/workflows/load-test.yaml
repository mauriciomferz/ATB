# ATB Load Test Workflow
# Runs k6 load tests on release candidates
name: Load Test

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL for load testing'
        required: true
        default: 'http://localhost:8080'
      vus:
        description: 'Number of virtual users'
        required: false
        default: '50'
      duration:
        description: 'Test duration'
        required: false
        default: '5m'
  
  release:
    types: [prereleased]

jobs:
  load-test:
    name: K6 Load Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup k6
        uses: grafana/setup-k6-action@v1
      
      - name: Run load test
        run: |
          k6 run \
            --vus ${{ github.event.inputs.vus || '50' }} \
            --duration ${{ github.event.inputs.duration || '5m' }} \
            -e BROKER_URL=${{ github.event.inputs.target_url || 'http://localhost:8080' }} \
            --out json=results.json \
            tests/load/broker_load.js
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-results
          path: results.json
      
      - name: Summary
        if: always()
        run: |
          echo "## Load Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **VUs**: ${{ github.event.inputs.vus || '50' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration**: ${{ github.event.inputs.duration || '5m' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: ${{ github.event.inputs.target_url || 'http://localhost:8080' }}" >> $GITHUB_STEP_SUMMARY
