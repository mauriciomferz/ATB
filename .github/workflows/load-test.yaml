# ATB Load Test Workflow
# Runs k6 load tests on release candidates
name: Load Test

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of load test'
        required: true
        default: 'load'
        type: choice
        options:
          - load
          - stress
          - soak
      target_url:
        description: 'Target URL for load testing (leave empty to use local stack)'
        required: false
        default: ''
      vus:
        description: 'Number of virtual users (ignored for stress/soak)'
        required: false
        default: '50'
      duration:
        description: 'Test duration (ignored for stress/soak)'
        required: false
        default: '5m'
  
  release:
    types: [prereleased]

jobs:
  load-test:
    name: K6 Load Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: atb-gateway-go/go.mod

      - name: Build images
        if: ${{ github.event.inputs.target_url == '' }}
        run: |
          cd atb-gateway-go
          docker build -f Dockerfile.broker -t atb-broker:local .
          docker build -f Dockerfile.agentauth -t atb-agentauth:local .

      - name: Generate certs
        if: ${{ github.event.inputs.target_url == '' }}
        run: |
          mkdir -p dev/certs
          cd dev/certs
          openssl genrsa -out ca.key 2048
          openssl req -new -x509 -days 1 -key ca.key -out ca.crt -subj "/CN=ATB CA"
          openssl genrsa -out server.key 2048
          openssl req -new -key server.key -out server.csr -subj "/CN=localhost"
          openssl x509 -req -days 1 -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt
          openssl genrsa -out client.key 2048
          openssl req -new -key client.key -out client.csr -subj "/CN=test-agent"
          openssl x509 -req -days 1 -in client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out client.crt
          cd ..
          openssl genpkey -algorithm ed25519 -out poa_ed25519.key
          openssl pkey -in poa_ed25519.key -pubout -out poa_ed25519.pub

      - name: Start local stack
        if: ${{ github.event.inputs.target_url == '' }}
        run: |
          docker compose -f docker-compose.minimal.yaml up -d
          sleep 10
          docker compose -f docker-compose.minimal.yaml ps

      - name: Setup k6
        uses: grafana/setup-k6-action@v1
      
      - name: Run load test
        run: |
          TARGET="${{ github.event.inputs.target_url }}"
          if [ -z "$TARGET" ]; then
            TARGET="http://localhost:8080"
          fi
          
          TEST_TYPE="${{ github.event.inputs.test_type || 'load' }}"
          
          case "$TEST_TYPE" in
            stress)
              k6 run --config tests/load/stress.json \
                -e BROKER_URL="$TARGET" \
                --out json=results.json \
                tests/load/atb_load.js
              ;;
            soak)
              k6 run --config tests/load/soak.json \
                -e BROKER_URL="$TARGET" \
                --out json=results.json \
                tests/load/atb_load.js
              ;;
            *)
              k6 run \
                --vus ${{ github.event.inputs.vus || '50' }} \
                --duration ${{ github.event.inputs.duration || '5m' }} \
                -e BROKER_URL="$TARGET" \
                --out json=results.json \
                tests/load/atb_load.js
              ;;
          esac

      - name: Stop local stack
        if: ${{ github.event.inputs.target_url == '' && always() }}
        run: docker compose -f docker-compose.minimal.yaml down
      
      - name: Upload results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: k6-results
          path: results.json
      
      - name: Summary
        if: always()
        run: |
          echo "## Load Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Type**: ${{ github.event.inputs.test_type || 'load' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **VUs**: ${{ github.event.inputs.vus || '50' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration**: ${{ github.event.inputs.duration || '5m' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: ${{ github.event.inputs.target_url || 'http://localhost:8080 (local stack)' }}" >> $GITHUB_STEP_SUMMARY
