namespace: atb

imagePullSecrets: []

broker:
  enabled: true
  name: broker
  image:
    repository: ghcr.io/mauriciomferz/atb-broker
    tag: "0.1.0"
    pullPolicy: IfNotPresent
  replicas: 1
  tls:
    # "secret" = mount a Kubernetes TLS secret and run file-based TLS
    # "spiffe" = run secret-less mTLS using SPIFFE Workload API (requires mounting the Workload API socket)
    mode: secret
    # Only used when mode=secret. If empty, defaults to "<release>-broker-tls".
    secretName: ""
  service:
    type: ClusterIP
    mtlsPort: 8443
    httpPort: 8080
  env:
    UPSTREAM_URL: "http://upstream.default.svc.cluster.local:9000"
    OPA_DECISION_URL: "http://{{ .Release.Name }}-opa.{{ .Values.namespace }}.svc.cluster.local:8181/v1/data/atb/poa/decision"
    POA_MAX_TTL_SECONDS: "300"
    # PoA verification: when empty and AgentAuth is enabled, the broker chart defaults this to the in-cluster AgentAuth JWKS endpoint.
    POA_JWKS_URL: ""
    POA_JWKS_CACHE_SECONDS: "300"
    POA_VERIFY_PUBKEY_PEM: ""
  resources: {}
  securityContext:
    runAsNonRoot: true
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true

pep:
  enabled: false

opa:
  enabled: true
  name: opa
  image:
    repository: openpolicyagent/opa
    tag: "0.66.0"
    pullPolicy: IfNotPresent
  replicas: 1
  service:
    type: ClusterIP
    port: 8181
  resources: {}

agentauth:
  enabled: true
  name: agentauth
  image:
    repository: ghcr.io/mauriciomferz/atb-agentauth
    tag: "0.1.0"
    pullPolicy: IfNotPresent
  replicas: 1
  service:
    type: ClusterIP
    port: 9090
  env:
    POA_ISSUER: "atb-agentauth"
    POA_TTL_SECONDS: "300"
    CHALLENGE_TTL_SECONDS: "300"
    # Optional: require this header for approvals (simulates MFA/approval gateway)
    APPROVAL_SHARED_SECRET: ""
    # Optional: Ed25519 signing key (PKCS8 PEM). Leave empty for ephemeral dev key.
    POA_SIGNING_ED25519_PRIVKEY_PEM: ""
  resources: {}

policy:
  regoConfigMapName: atb-opa-policy
  regoKey: poa.rego

observability:
  prometheus:
    enabled: false
    serviceMonitor:
      enabled: false
      interval: 30s
      scrapeTimeout: 10s
  otel:
    enabled: false
    endpoint: "http://otel-collector.monitoring.svc.cluster.local:4318"
    sampler: "parentbased_traceidratio"
    samplerArg: "0.1"

csi:
  enabled: false
  driver: "csi.spiffe.io"
  mountPath: "/spire-agent-socket"
  socketFile: "workload-api.sock"
