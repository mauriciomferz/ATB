# SPIRE Server Configuration for Nested Industrial Site
# Acts as a downstream server receiving trust from the enterprise root

server {
    bind_address = "0.0.0.0"
    bind_port = "8081"
    
    # Trust domain for this industrial site
    trust_domain = "industrial.atb.example.com"
    
    data_dir = "/opt/spire/data/server"
    log_level = "INFO"
    log_file = "/var/log/spire/server.log"
    
    # CA configuration
    ca_ttl = "24h"
    default_x509_svid_ttl = "1h"
    default_jwt_svid_ttl = "5m"
    
    # Federation with enterprise root
    federation {
        bundle_endpoint {
            address = "0.0.0.0"
            port = 8443
        }
    }
}

plugins {
    # Upstream Authority - chain to enterprise SPIRE root
    UpstreamAuthority "spire" {
        plugin_data {
            server_address = "spire-root.enterprise.atb.example.com"
            server_port = "8081"
            
            # Path to trust bundle from enterprise root
            workload_api_socket = "/run/spire/sockets/agent.sock"
        }
    }
    
    # TPM DevID Node Attestor - verify TPM-based device identity
    NodeAttestor "tpm_devid" {
        plugin_data {
            # Trust store for DevID certificates
            ca_path = "/etc/spire/devid-ca"
            
            # Endorsement Key CA for TPM verification
            endorsement_ca_path = "/etc/spire/ek-ca"
            
            # Hash algorithm for attestation
            hash_algorithm = "sha256"
        }
    }
    
    # Data store - SQLite for edge deployments
    DataStore "sql" {
        plugin_data {
            database_type = "sqlite3"
            connection_string = "/opt/spire/data/server/datastore.sqlite3"
        }
    }
    
    # Key manager
    KeyManager "disk" {
        plugin_data {
            keys_path = "/opt/spire/data/server/keys.json"
        }
    }
    
    # Notifier for cache invalidation
    Notifier "k8sbundle" {
        plugin_data {
            namespace = "spire"
            config_map = "spire-bundle"
        }
    }
}

# Health checks
health_checks {
    listener_enabled = true
    bind_address = "0.0.0.0"
    bind_port = "8080"
    live_path = "/live"
    ready_path = "/ready"
}

# Telemetry
telemetry {
    Prometheus {
        host = "0.0.0.0"
        port = 9988
    }
}
