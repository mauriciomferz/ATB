# SPIRE Agent Configuration for TPM DevID Attestation
# For industrial edge devices with TPM 2.0

agent {
    data_dir = "/opt/spire/data/agent"
    log_level = "INFO"
    log_file = "/var/log/spire/agent.log"
    
    # Trust domain - should match nested SPIRE server at site level
    trust_domain = "industrial.atb.example.com"
    
    # Nested SPIRE server at this industrial site
    server_address = "spire-server.site-a.local"
    server_port = "8081"
    
    # Socket for workloads
    socket_path = "/run/spire/sockets/agent.sock"
    
    # Enable admin API for debugging (disable in production)
    admin_socket_path = "/run/spire/sockets/admin.sock"
}

plugins {
    # TPM DevID Attestor - uses TPM 2.0 for hardware-backed identity
    NodeAttestor "tpm_devid" {
        plugin_data {
            # Path to TPM device
            devid_cert_path = "/etc/spire/devid/cert.pem"
            devid_priv_path = "/etc/spire/devid/key.pem"
            
            # TPM options
            tpm_device_path = "/dev/tpmrm0"
            
            # Endorsement Key certificate for TPM verification
            ek_cert_path = "/etc/spire/devid/ek_cert.pem"
        }
    }
    
    # Workload Attestor - identifies workloads by process attributes
    WorkloadAttestor "unix" {
        plugin_data {
            discover_workload_path = true
        }
    }
    
    # For containerized workloads
    WorkloadAttestor "docker" {
        plugin_data {
            docker_socket_path = "unix:///var/run/docker.sock"
        }
    }
    
    # Key manager - use TPM for key storage
    KeyManager "disk" {
        plugin_data {
            keys_path = "/opt/spire/data/agent/keys.json"
        }
    }
}

# Telemetry for monitoring
telemetry {
    Prometheus {
        host = "0.0.0.0"
        port = 9988
    }
}

# Health check endpoint
health_checks {
    listener_enabled = true
    bind_address = "0.0.0.0"
    bind_port = "8080"
    live_path = "/live"
    ready_path = "/ready"
}
